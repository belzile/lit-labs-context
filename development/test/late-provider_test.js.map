{"version":3,"file":"late-provider_test.js","sourceRoot":"","sources":["../../src/test/late-provider_test.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright 2021 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport {LitElement, html, TemplateResult} from 'lit';\nimport {property} from 'lit/decorators/property.js';\n\nimport {ContextKey} from '../index.js';\nimport {contextProvided} from '../lib/decorators/context-provided.js';\nimport {contextProvider} from '../lib/decorators/context-provider.js';\nimport {assert} from '@esm-bundle/chai';\nimport {ContextRoot} from '../lib/context-root.js';\n\nconst simpleContext = 'simple-context' as ContextKey<'simple-context', number>;\n\nclass ContextConsumerElement extends LitElement {\n  @contextProvided({context: simpleContext, subscribe: true})\n  @property({type: Number})\n  public value = 0;\n\n  @contextProvided({context: simpleContext})\n  @property({type: Number})\n  public onceValue = 0;\n\n  protected render(): TemplateResult {\n    return html`Value <span id=\"value\">${this.value}</span>`;\n  }\n}\ncustomElements.define('context-consumer', ContextConsumerElement);\n\nclass LateContextProviderElement extends LitElement {\n  @contextProvider({context: simpleContext})\n  @property({type: Number, reflect: true})\n  public value = 0;\n\n  protected render(): TemplateResult {\n    return html`\n      <div>\n        <slot></slot>\n      </div>\n    `;\n  }\n}\n\nsuite('late context provider', () => {\n  let consumer: ContextConsumerElement;\n  let provider: LateContextProviderElement;\n  let container: HTMLElement;\n  setup(async () => {\n    container = document.createElement('div');\n\n    // add a root context to catch late providers and re-dispatch requests\n    new ContextRoot().attach(container);\n\n    container.innerHTML = `\n         <late-context-provider value=\"1000\">            \n             <context-consumer></context-consumer>\n         </late-context-provider>\n     `;\n    document.body.appendChild(container);\n\n    provider = container.querySelector(\n      'late-context-provider'\n    ) as LateContextProviderElement;\n\n    consumer = container.querySelector(\n      'context-consumer'\n    ) as ContextConsumerElement;\n\n    await consumer.updateComplete;\n\n    assert.isDefined(consumer);\n  });\n\n  teardown(() => {\n    document.body.removeChild(container);\n  });\n\n  test(`handles late upgrade properly`, async () => {\n    // initially consumer has initial value\n    assert.strictEqual(consumer.value, 0);\n    assert.strictEqual(consumer.onceValue, 0);\n    // do upgrade\n    customElements.define('late-context-provider', LateContextProviderElement);\n    // await update of provider component\n    await provider.updateComplete;\n    // await update of consumer component\n    await consumer.updateComplete;\n    // should now have provided context\n    assert.strictEqual(consumer.value, 1000);\n    // but only to the subscribed value\n    assert.strictEqual(consumer.onceValue, 0);\n    // confirm subscription is established\n    provider.value = 500;\n    await consumer.updateComplete;\n    assert.strictEqual(consumer.value, 500);\n    // and once was not updated\n    assert.strictEqual(consumer.onceValue, 0);\n  });\n});\n"]}